package dao

import (
	"context"
	"errors"

	"gorm.io/gorm"
)

type {{.DomainName}} struct {
	gorm.Model
}

func ({{.DomainName}}) TableName() string {
	return "{{.TableName}}"
}

type I{{.DomainName}}Dao interface {
	Create{{.DomainName}}(ctx context.Context, {{.UnderlineName}} *{{.DomainName}}) error
	Update{{.DomainName}}(ctx context.Context, id uint, {{.UnderlineName}} *{{.DomainName}}) error
	Delete{{.DomainName}}(ctx context.Context, id uint) error
	Get{{.DomainName}}ById(ctx context.Context, id uint) (*{{.DomainName}}, error)
	GetAllCount(ctx context.Context) (int64, error)
	Query{{.DomainName}}List(ctx context.Context, limit int64, skip int64) ([]*{{.DomainName}}, error)
}

var _ I{{.DomainName}}Dao = (*{{.DomainName}}Dao)(nil)

func New{{.DomainName}}Dao(db *gorm.DB) *{{.DomainName}}Dao {
	db.AutoMigrate(&{{.DomainName}}{})
	return &{{.DomainName}}Dao{db: db}
}

type {{.DomainName}}Dao struct {
	db *gorm.DB
}

// Create{{.DomainName}} 创建{{.DomainName}}
func (d *{{.DomainName}}Dao) Create{{.DomainName}}(ctx context.Context, {{.UnderlineName}} *{{.DomainName}}) error {
	return d.db.Model(&{{.DomainName}}{}).Create({{.UnderlineName}}).Error
}

// Update{{.DomainName}} 更新{{.DomainName}}
func (d *{{.DomainName}}Dao) Update{{.DomainName}}(ctx context.Context, id uint, {{.UnderlineName}} *{{.DomainName}}) error {
	res := d.db.Model(&{{.DomainName}}{}).Where("id = ?", id).Updates({{.UnderlineName}})
	if err := res.Error; err != nil {
		return err
	}
	if res.RowsAffected == 0 {
		return errors.New("更新{{.DomainName}}失败")
	}
	return nil
}

// Delete{{.DomainName}} 删除{{.DomainName}}
func (d *{{.DomainName}}Dao) Delete{{.DomainName}}(ctx context.Context, id uint) error {
	res := d.db.Model(&{{.DomainName}}{}).Where("id = ?", id).Delete(&{{.DomainName}}{})
	if err := res.Error; err != nil {
		return err
	}
	if res.RowsAffected == 0 {
		return errors.New("删除{{.DomainName}}失败")
	}
	return nil
}

// Get{{.DomainName}}ById 根据id获取{{.DomainName}}
func (d *{{.DomainName}}Dao) Get{{.DomainName}}ById(ctx context.Context, id uint) (*{{.DomainName}}, error) {
	var {{.UnderlineName}} {{.DomainName}}
	err := d.db.Model(&{{.DomainName}}{}).Where("id = ?", id).First(&{{.UnderlineName}}).Error
	if err != nil {
		return nil, err
	}
	return &{{.UnderlineName}}, nil
}

// GetAllCount 获取所有{{.DomainName}}数量
func (d *{{.DomainName}}Dao) GetAllCount(ctx context.Context) (int64, error) {
	var count int64
	err := d.db.Model(&{{.DomainName}}{}).Count(&count).Error
	if err != nil {
		return 0, err
	}
	return count, nil
}

// Query{{.DomainName}}List 分页查询{{.DomainName}}
func (d *{{.DomainName}}Dao) Query{{.DomainName}}List(ctx context.Context, limit int64, skip int64) ([]*{{.DomainName}}, error) {
	{{.UnderlineName}}List := make([]*{{.DomainName}}, 0)
	err := d.db.Model(&{{.DomainName}}{}).Limit(int(limit)).Offset(int(skip)).Find(&{{.UnderlineName}}List).Error
	if err != nil {
		return nil, err
	}
	return {{.UnderlineName}}List, nil
}
